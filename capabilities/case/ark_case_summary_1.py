import os
from volcenginesdkarkruntime import Ark

API_KEY = os.environ.get("ARK_API_KEY")
API_EP_ID = os.environ.get("ARK_API_ENGPOINT_ID")

prompt_system = """
你作为专业售后服务优化专家，需要精准解析客户服务对话文档并生成结构化工单概要。请按以下流程处理：

执行步骤：

1. 对话要素提取：
- 用<对话标记>标注客户与客服的每次发言
- 识别发言中明确提及的实体信息（姓名、电话、地址等）
- 标注关键时间节点和服务承诺

2. 逻辑关系构建：
- 绘制<信息关联图>体现：
  ▪ 客户身份与来电人关系
  ▪ 问题类型与服务路径的对应
  ▪ 时间敏感度与紧急程度关联

3. 字段填充规则：
- 必填字段必须从对话中直接提取或通过以下逻辑推导：
  ▪ 紧急级别=常规：处理期限≤3工作日
  ▪ 紧急级别=中等：处理期限≤24小时 
  ▪ 紧急级别=紧急：处理期限≤4小时
- 验证类型判定标准：
  ▪ 涉及资金操作=交易验证
  ▪ 纯信息咨询=查询验证
  ▪ 未完成身份核验=未验证

4. 智能推断机制：
- 当字段信息缺失时，按优先级选择：
  ① 对话中的隐含信息（如地址可联系产品注册地）
  ② 企业知识库默认值（如回复方式优先电话）
  ③ 行业通用处理规范


请严格按照以下JSON格式输出，注意：
- 金额单位统一转换为人民币元
- 时间格式遵循ISO 8601标准
- 枚举字段使用预定义值（如"紧急级别"只接受常规/中等/紧急）
- 空值字段用null表示

{工单概要JSON结构}


特别注意事项：
1. 仅处理与工单构建直接相关的内容
2. 发现对话矛盾时，以客户最后陈述为准
3. 涉及隐私信息需模糊处理（如部分隐藏电话号码）
4. 中文输出且保持专业书面语
"""

ptompt_user = """
你好，我最近购买了你们的智能手机，但它频繁死机，已经影响了我的正常使用。我已经尝试了重启设备，但问题依然存在。请问你们能帮我解决吗？我已经重启了设备，问题没有解决。我的手机现在根本无法正常使用，麻烦你们尽快处理。希望能够更换手机或退款。我已经提供了购买凭证和序列号，客服电话等待时间也非常长，服务态度也不太好。希望你们能够尽快处理，我已经不想再等待了。非常抱歉给您带来困扰，感谢您的耐心配合。我们会尽快安排处理您的问题。请您耐心等待，我们会在24小时内与您取得联系。我不想再等了，希望能在3个工作日内解决我的问题。我们将会优先处理您的问题，尽量在3个工作日内解决。感谢您的理解与支持，您可以随时联系我们查询进展。
"""

client = Ark(api_key=API_KEY)
completion = client.chat.completions.create(
    model=API_EP_ID,
    messages=[
        {"role": "system", "content": prompt_system},
        {"role": "user", "content": ptompt_user},
    ]
)

print(completion.choices[0].message.content)

print(completion.usage)

