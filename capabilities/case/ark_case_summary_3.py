import os
from volcenginesdkarkruntime import Ark

API_KEY = os.environ.get("ARK_API_KEY")
API_EP_ID = os.environ.get("ARK_API_ENGPOINT_ID")

prompt_system = """
你作为专业售后服务优化专家，需要精准解析客户服务对话文档并生成结构化工单概要。请按以下流程处理：

执行步骤：

1. 对话要素提取：
- 用<对话标记>标注客户与客服的每次发言
- 识别发言中明确提及的实体信息（姓名、电话、地址等）
- 标注关键时间节点和服务承诺

2. 逻辑关系构建：
- 绘制<信息关联图>体现：
  ▪ 客户身份与来电人关系
  ▪ 问题类型与服务路径的对应
  ▪ 时间敏感度与紧急程度关联

3. 字段填充规则：
- 必填字段必须从对话中直接提取或通过以下逻辑推导：
  ▪ 紧急级别=常规：处理期限≤3工作日
  ▪ 紧急级别=中等：处理期限≤24小时 
  ▪ 紧急级别=紧急：处理期限≤4小时
- 验证类型判定标准：
  ▪ 涉及资金操作=交易验证
  ▪ 纯信息咨询=查询验证
  ▪ 未完成身份核验=未验证

4. 智能推断机制：
- 当字段信息缺失时，按优先级选择：
  ① 对话中的隐含信息（如地址可联系产品注册地）
  ② 企业知识库默认值（如回复方式优先电话）
  ③ 行业通用处理规范


请严格按照以下JSON格式输出，注意：
- 金额单位统一转换为人民币元
- 时间格式遵循ISO 8601标准
- 枚举字段使用预定义值（如"紧急级别"只接受常规/中等/紧急）
- 空值字段用null表示

{工单概要JSON结构}


特别注意事项：
1. 仅处理与工单构建直接相关的内容
2. 发现对话矛盾时，以客户最后陈述为准
3. 涉及隐私信息需模糊处理（如部分隐藏电话号码）
4. 中文输出且保持专业书面语
"""

ptompt_user = """
你好，我叫王芳，上个月也就是 2025 年 1 月 15 号在你们这买了一台笔记本电脑。今天是 2025 年 2 月 23 号，用了没多久就出问题了，屏幕老是闪烁。我家在上海市浦东新区 XX 路 456 号，电话是 139 - 2345 - 6789。你们看看咋解决这事儿，我希望尽快处理，最好明天（2025 年 2 月 24 号）就有个方案。
您好，王芳女士，很抱歉给您带来不好的体验。我们已经记录下您的问题，现在安排技术人员先跟您电话沟通下具体情况，初步判断下问题所在。正常流程排查和处理可能需要 2 个工作日。
2 个工作日太长了，我工作就靠这电脑呢，耽误不起时间。你们必须明天就上门检修，不然我这损失你们负责。
王女士您先消消气，我们这边马上调整安排，一定在明天安排师傅上门给您检修电脑，有任何进展会随时跟您反馈。
行吧，希望你们能说到做到，尽快把问题解决好。
"""

client = Ark(api_key=API_KEY)
completion = client.chat.completions.create(
    model=API_EP_ID,
    messages=[
        {"role": "system", "content": prompt_system},
        {"role": "user", "content": ptompt_user},
    ]
)

print(completion.choices[0].message.content)

print(completion.usage)

